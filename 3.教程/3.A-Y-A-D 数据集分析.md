# Yelp 数据集分析

Apache Drill 是开源项目发展速度最快的项目之一，社区每月会发布一个版本。关键的不同点是 Drill 具有其敏捷性和灵活性。在会议上提出 SQL On Hadoop，用于完成低延时的性能指标，Drill 允许用户在没有 ETL 或事先没有定义 Schema 的情况下，完成数据的分析。数据可以为任意格式，例如 text，JSON 或是 Parquet。数据可以是简单类型，例如：string，integer，date 或是更加复杂结构数据，例如嵌套的 Map 集合和数组。数据可以在任何文件系统中存在，本地或是分布式中，例如 HDFS 或是 S3。Drill，有一个“无 Schema”的途径，它能够让你只需要几分钟，就能从你的数据中获得想要的值。

让我们快速的通过需要安装 Drill 和需要运行 Yelp 数据集的步骤。从 Yelp 中下载公开的示例数据集并将其格式化为 JSON。

# 安装和启动 Drill

## 下载 Apache Drill 到你本地机器

在本地进行 Drill 实验，按照 [快速指导](2.Drill in 10 Minutes 快速指导.md)的步骤进行实验。

另外，如果你想扩展你的环境，你可以将 Drill 部署在分布式环境下。

下面，让我们尝试用一些 SQL 示例，去理解 Drill 如何简易的分析数据。

```
注释：

你需要替换你本地路径的 Yelp 数据集在角括号中，针对你运行的每个查询。
```

# 在 Drill 中查询数据

## 1.可视化 Yelp 的业务数据

```bash
0: jdbc:drill:zk=local> !set maxwidth 10000

0: jdbc:drill:zk=local> select * from
    dfs.`<path-to-yelp-dataset>/yelp/yelp_academic_dataset_business.json`
    limit 1;

+------------------------+----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------+--------------------------------+---------+--------------+-------------------+-------------+-------+-------+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+----------+---------------+
| business_id            | full_address                                       | hours                                                                                                                                                                                                                                                      | open | categories                     | city    | review_count | name              | longitude   | state | stars | latitude  | attributes                                                                                                                                                   | type     | neighborhoods |
+------------------------+----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------+--------------------------------+---------+--------------+-------------------+-------------+-------+-------+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+----------+---------------+
| vcNAWiLM4dR7D2nwwJ7nCA | 4840 E Indian School Rd Ste 101, Phoenix, AZ 85018 | fill in{"Tuesday":{"close":"17:00","open":"08:00"},"Friday":{"close":"17:00","open":"08:00"},"Monday":{"close":"17:00","open":"08:00"},"Wednesday":{"close":"17:00","open":"08:00"},"Thursday":{"close":"17:00","open":"08:00"},"Sunday":{},"Saturday":{}} | true | ["Doctors","Health & Medical"] | Phoenix | 7            | Eric Goldberg, MD | -111.983758 | AZ    | 3.5   | 33.499313 | {"By Appointment Only":true,"Good For":{},"Ambience":{},"Parking":{},"Music":{},"Hair Types Specialized In":{},"Payment Types":{},"Dietary Restrictions":{}} | business | []            |
+------------------------+----------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------+--------------------------------+---------+--------------+-------------------+-------------+-------+-------+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------+----------+---------------+
```

```
注释：

本文件以示例为目的对 Drill 结果进行输出。这种输出是不对称的（即：不能完全匹配）。
```

你可以直接查询自定义的文件，例如 JSON，Parquet 和 text 文件。它们不需要创建和定义元数据在 Hive 的元数据中。

## 2.进一步探索业务数据集

在数据集中的浏览总数：

```bash
0: jdbc:drill:zk=local> select sum(review_count) as totalreviews
from dfs.`/<path-to-yelp-dataset>/yelp/yelp_academic_dataset_business.json`;

+--------------+
| totalreviews |
+--------------+
| 1236445      |
+--------------+
```

国家和城市总数的评论：

```bash
0: jdbc:drill:zk=local> select state, city, count(*) totalreviews
from dfs.`/<path-to-yelp-dataset>/yelp/yelp_academic_dataset_business.json`
group by state, city order by count(*) desc limit 10;

+------------+------------+--------------+
|   state    |    city    | totalreviews |
+------------+------------+--------------+
| NV         | Las Vegas  | 12021        |
| AZ         | Phoenix    | 7499         |
| AZ         | Scottsdale | 3605         |
| EDH        | Edinburgh  | 2804         |
| AZ         | Mesa       | 2041         |
| AZ         | Tempe      | 2025         |
| NV         | Henderson  | 1914         |
| AZ         | Chandler   | 1637         |
| WI         | Madison    | 1630         |
| AZ         | Glendale   | 1196         |
+------------+------------+--------------+
```

每一个企业星级评定的平均次数

```bash
0: jdbc:drill:zk=local> select stars,trunc(avg(review_count)) reviewsavg
from dfs.`/<path-to-yelp-dataset>/yelp/yelp_academic_dataset_business.json`
group by stars order by stars desc;

+------------+------------+
|   stars    | reviewsavg |
+------------+------------+
| 5.0        | 8.0        |
| 4.5        | 28.0       |
| 4.0        | 48.0       |
| 3.5        | 35.0       |
| 3.0        | 26.0       |
| 2.5        | 16.0       |
| 2.0        | 11.0       |
| 1.5        | 9.0        |
| 1.0        | 4.0        |
+------------+------------+
```

具有高评论数的顶级企业（1000）

```bash
0: jdbc:drill:zk=local> select name, state, city, `review_count` from
dfs.`/<path-to-yelp-dataset>/yelp/yelp_academic_dataset_business.json`
where review_count > 1000 order by `review_count` desc limit 10;

+-------------------------------+-------------+------------+---------------+
|           name                |   state     |    city    |  review_count |
+-------------------------------+-------------+------------+---------------+
| Mon Ami Gabi                  | NV          | Las Vegas  | 4084          |
| Earl of Sandwich              | NV          | Las Vegas  | 3655          |
| Wicked Spoon                  | NV          | Las Vegas  | 3408          |
| The Buffet                    | NV          | Las Vegas  | 2791          |
| Serendipity 3                 | NV          | Las Vegas  | 2682          |
| Bouchon                       | NV          | Las Vegas  | 2419          |
| The Buffet at Bellagio        | NV          | Las Vegas  | 2404          |
| Bacchanal Buffet              | NV          | Las Vegas  | 2369          |
| The Cosmopolitan of Las Vegas | NV          | Las Vegas  | 2253          |
| Aria Hotel & Casino           | NV          | Las Vegas  | 2224          |
+-------------------------------+-------------+----------------------------+
```

星期六开放和关闭时间为数不多的企业

```bash
0: jdbc:drill:zk=local> select b.name, b.hours.Saturday.`open`,
b.hours.Saturday.`close`  
from
dfs.`/<path-to-yelp-dataset>/yelp/yelp_academic_dataset_business.json`
b limit 10;

+----------------------------+------------+------------+
|    name                    |   EXPR$1   |   EXPR$2   |
+----------------------------+------------+------------+
| Eric Goldberg, MD          | 08:00      | 17:00      |
| Pine Cone Restaurant       | null       | null       |
| Deforest Family Restaurant | 06:00      | 22:00      |
| Culver's                   | 10:30      | 22:00      |
| Chang Jiang Chinese Kitchen| 11:00      | 22:00      |
| Charter Communications     | null       | null       |
| Air Quality Systems        | null       | null       |
| McFarland Public Library   | 09:00      | 20:00      |
| Green Lantern Restaurant   | 06:00      | 02:00      |
| Spartan Animal Hospital    | 07:30      | 18:00      |
+----------------------------+------------+------------+
```

需要注意的是，Drill 是如何进行多层嵌套的。

## 3.从业务数据集中获取设备

注意，在 Yelp 的业务数据集中的列属性每一行都是不同的，代表企业可以拥有单独的设备。Drill 可以快速的，容易的去访问这些数据集并改变它们的 Schema。

首先，改变 Drill 的工作在所有的 text 模式中（这样我们可以看一看所有的数据）。

```bash
0: jdbc:drill:zk=local> alter system set `store.json.all_text_mode` = true;
+------------+-----------------------------------+
|     ok     |  summary                          |
+------------+-----------------------------------+
| true       | store.json.all_text_mode updated. |
+------------+-----------------------------------+
```
