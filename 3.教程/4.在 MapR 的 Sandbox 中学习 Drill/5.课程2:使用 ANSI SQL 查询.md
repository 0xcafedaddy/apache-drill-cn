# 使用 ANSI SQL 查询

## 目标

本节课展示在 Apache Drill 中如何去使用标准的 SQL 做分析：例如，使用聚合函数和 JOIN 用法。值得注意的是，Apache Drill 提供 ANSI SQL 支持，而不是一个 SQL 接口。

## 查询

现在，你知道了数据源的原始形式，使用 ``` select * ``` 去查询，尝试在每个数据源上运行一些简单但更有用的查询。这些查询演示了 Drill 是如何支持 ANSI SQL，并且是如何在一个 ``` SELECT ``` 语句中结合不同数据源的数据的。

* 展示聚合查询在一个单独的文件或是表中。使用 ``` GROUP BY， WHERE， HAVING， ORDER BY ``` 语法。
* 在 Hive，MapR-DB，和文件系统的数据源中执行 ``` JOIN ```。
* 使用表和列的别名。
* 创建一个 Drill 视图。
## 聚合

### 切换到 hive 的 schema：

```bash
0: jdbc:drill:> use hive.`default`;
+-------+-------------------------------------------+
|  ok   |                  summary                  |
+-------+-------------------------------------------+
| true  | Default schema changed to [hive.default]  |
+-------+-------------------------------------------+
1 row selected
```

### 按月返回销售总量：

```bash
0: jdbc:drill:> select `month`, sum(order_total)
from orders group by `month` order by 2 desc;
+------------+---------+
|   month    | EXPR$1  |
+------------+---------+
| June       | 950481  |
| May        | 947796  |
| March      | 836809  |
| April      | 807291  |
| July       | 757395  |
| October    | 676236  |
| August     | 572269  |
| February   | 532901  |
| September  | 373100  |
| January    | 346536  |
+------------+---------+
10 rows selected
```

Drill 是支持 SQL 的聚合函数的，例如 SUM，MAX，AVG 和 MIN。标准的 SQL 语法以同样的方式运行在 Drill 查询中是和关系型数据库一样的。

需要注意的是，标记返回的 “month” 列是因为其在 SQL 中是保留字符，所以，需要加上引号。

### 按 month 和 state 字段分组，返回前 20 行销售总额：
```bash
0: jdbc:drill:> select `month`, state, sum(order_total) as sales from orders group by `month`, state
order by 3 desc limit 20;
+-----------+--------+---------+
|   month   | state  |  sales  |
+-----------+--------+---------+
| May       | ca     | 119586  |
| June      | ca     | 116322  |
| April     | ca     | 101363  |
| March     | ca     | 99540   |
| July      | ca     | 90285   |
| October   | ca     | 80090   |
| June      | tx     | 78363   |
| May       | tx     | 77247   |
| March     | tx     | 73815   |
| August    | ca     | 71255   |
| April     | tx     | 68385   |
| July      | tx     | 63858   |
| February  | ca     | 63527   |
| June      | fl     | 62199   |
| June      | ny     | 62052   |
| May       | fl     | 61651   |
| May       | ny     | 59369   |
| October   | tx     | 55076   |
| March     | fl     | 54867   |
| March     | ny     | 52101   |
+-----------+--------+---------+
20 rows selected
```

值得一提的是，这里将别名用在了 SUM 聚合函数上。Drill 是支持列别名和表别名的。

## HAVING 语法

使用 ``` HAVING ``` 语法来约束聚合结果。

### 切换到 dfs.clicks 工作区间

```bash
0: jdbc:drill:> use dfs.clicks;
+-------+-----------------------------------------+
|  ok   |                 summary                 |
+-------+-----------------------------------------+
| true  | Default schema changed to [dfs.clicks]  |
+-------+-----------------------------------------+
1 row selected
```

### 按设备分组，设备点击数高过一定阀值的总数：

```bash
0: jdbc:drill:> select t.user_info.device, count(*) from `clicks/clicks.json` t
group by t.user_info.device
having count(*) > 1000;
+---------+---------+
| EXPR$0  | EXPR$1  |
+---------+---------+
| IOS5    | 11814   |
| AOS4.2  | 5986    |
| IOS6    | 4464    |
| IOS7    | 3135    |
| AOS4.4  | 1562    |
| AOS4.3  | 3039    |
+---------+---------+
6 rows selected
```

聚合函数从点击量的数据中，统计不同手机设备的点击量。在查询是附加激活和注册的设备总量必须大于 1000，方能返回统计结果。
