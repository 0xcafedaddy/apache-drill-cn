# 配置模拟身份

模拟允许服务的行为，执行客户端所请求的动作。默认情况下，模拟身份在 Drill 上是禁止的。你可以配置模拟身份在 ``` /conf/drill-override.conf ``` 文件下。

当你启用模拟身份，Drill 会执行客户端请求，让用户登录到客户端。Drill 将用户凭证传递给文件系统，然后文件系统会检查该用户是否有权限访问数据。当你启用认证，Drill 用可插拔认证模块（PAM）来验证用户的身份之前，用户可以访问 Drillbit。详情见用户验证。

如果模拟身份没有配置，Drill 执行所有客户端请求，在文件系统为用户服务的节点上启动 Drillbit 服务。这是一个典型的特权用户。该文件系统验证该系统用户具有访问数据的权限。

## 例子

当模拟身份被禁用，然后用户通过 SQLLine 客户端发送一个查询请求，SQLLine 会通过查询去连接 Drillbit。Drillbit 执行查询的系统用户，会在节点上开始处理。例如，我们假设系统用户已经完全访问文件系统。Drill 执行该查询并将结果返回给客户端。

![4XxQK2I.png](../res/4XxQK2I.png)

当模拟身份被启用，用户通过 SQLLine 客户端发送一个请求，Drillbit 会先验证该用户访问文件系统中数据的权限。如果有，Drill 将查询结果返回给客户端。如果该用户没有权限，Drill 返回一个错误。

![oigWqVg.png](../res/oigWqVg.png)

## 模拟身份支持

下表列出了客户端，存储插件，查询类型，可以在 Drill 中使用模拟身份：

| 类型 | 支持 | 不支持 |
| -- | -- | -- |
| 客户端 | SQLLine，ODBC，JDBC | Drill Web 控制台，REST API |
| 存储插件 | 文件系统 | Hive，HBase |
| 查询 | 当你启动模拟身份，设置适用于对数据和元数据的查询。例如，如果你使用 SHOW SCHEMAS 命令，Drill 模拟用户登录到客户端去访问元数据。如果你使用 SELECT 查询工作区间，Drill 模拟用户登录到客户端去访问数据。Drill 模拟用户的查询适用以下命令： SHOW SCHEMAS，SHOW DATABASES，SHOW TABLES，CTAS，SELECT，CREATE VIEW，DROP VIEW，SHOW FILES。为了成功运行 CTAS 和 CREATE VIEW 命令，用户必须在存在的表和视图上拥有写权限。运行这些命令在文件系统中创建部件| 无 |

##模拟身份和视图

你可以使用视图的模拟提供访问数据和保护敏感信息。当你创建一个视图，Drill 会以后缀名为 ``` .drill.view ``` 存储一个视图到文件中。例如，如果你创建一个视图的名字叫 myview，Drill 创建一个视图文件叫 myview.drill.view 并保存它到当前的工作目录或是指定的工作目录，例如 dfs.views.myview。详见 [CREATE VIEW](#) 命令。

你可以创建一个视图并授予读的权限，该读权限是对于其他用户访问时的权限。当一个用户查询视图，Drill 模拟视图所属者访问底层的数据。如果用户尝试访问数据目录，Drill 会返回一个权限不足的错误。访问视图的用户可以从源视图中创建新视图，以进一步限制数据的访问。

## 视图权限

用户必须有写权限在该目录或者拥有在工作区间去创建一个视图，和前面提到的读取表或视图一样。当用户创建一个视图，权限默认设置为它自己。用户可以查询存在的视图或创建一个新视图从现有的视图中，如果他们有读取视图的权限，它们会被存储在在目录或工作区间。

当用户查询一个视图，Drill 访问创建视图的基础数据。如果用户没有访问视图的权限，该查询失败，并返回一个错误。只有视图的所有者或者超级用户可以修改视图的权限。

视图的所属者或超级用户权限，可以直接修改视图文件或设置权限在系统或会话级别创建视图之前。任何修改视图权限的用户都必须在其工作目录或工作区间上拥有写权限。

## 在视图文件上修改权限

只有视图的所属者或超级用户能够修改视图文件去改变它们的从个人到组。之前你授权给用户去访问视图，验证他们有权限去访问目录或工作区间在存储的视图文件中。

使用 ``` chmod ``` 或 ``` chown ``` 命令去改变一个视图文件的权限。
```bash
hadoop fs –chmod <octal code> <file_name>
hadoop fs –chown <user>:<group> <file_name>
```

例如：``` hadoop fs –chmod 750 employees.drill.view ```

## 修改系统/会话级别的视图权限

使用 ``` ALTER SESSION|SYSTEM ``` 命令并结合 ``` new_view_default_permissions ``` 参数，去设置视图权限。
```bash
ALTER SESSION SET `new_view_default_permissions` = '<octal_code>';
ALTER SYSTEM SET `new_view_default_permissions` = '<octal_code>';
```

例如：``` ALTER SESSION SET `new_view_default_permissions` = '777'; ```

在你设置该参数之后，在会话或在系统级设置的所有会话中创建的每一个视图中具有相同的权限。

## 链接模拟

当你在 ``` drill-override.conf ``` 文件中，启用模拟后，你可以在视图中设置允许链接模拟。链接模拟控制身份转变的次数，当用户查询一个视图的时候，每个身份转换等于一次跳转。
